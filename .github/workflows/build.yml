name: Build
on:
  push:
    paths-ignore:
      - '.gitignore'
      - '*.md'
  
  #schedule:
  #  - cron: '0 8 * * *' # run at 8 AM UTC/ 12 AM AKDT

  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        build_type: ['debug', 'release']
        config:
          - { name: 'üçè macOS', target: mac-universal, pkgformat: none, os: macos-latest }
          - { name: 'üêß Linux', target: linux-amd64, pkgformat: none, os: ubuntu-latest }
          - { name: 'ü™ü Windows', target: windows-amd64, pkgformat: nsis, os: ubuntu-latest }

    name: üõ† Build / ${{ matrix.config.name }} (${{ matrix.build_type }})
    runs-on: ${{ matrix.config.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          lfs: true
      
      - name: Setup Node.js environment
        uses: actions/setup-node@v3.9.1
        
      - name: Setup Godot
        if: matrix.config.os != 'windows-latest'
        # You may pin to the exact commit or the version.
        # uses: lihop/godot-setup@f62f7730e1811dc58bb7edc426c1bdbd80bb0c08
        uses: lihop/godot-setup@v2.1.3
        with:
          # Godot version to use
          version: 4.4.1-stable
          export-templates: true

      - name: Install Dependencies (macOS)
        if: matrix.config.os == 'macos-latest'
        run: brew install haxe

      - name: Install Dependencies (Linux)
        if: matrix.config.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y haxe nsis

      - name: Install Dependencies (Windows)
        if: matrix.config.os == 'windows-latest'
        run: |
          choco upgrade haxe godot
          npm install @nsis-u/makensis

      - name: Test Godot
        run: |
          godot --version
      
      - name: Setup Haxelib
        run: |
          mkdir -p ~/.hxlib
          haxelib setup ~/.hxlib
          haxelib --global update haxelib
      
      - name: Install haxelib dependencies
        run: |
          haxelib git sunaba https://github.com/sunabagg/sunaba.git
          haxelib git tsukuru https://github.com/sunabagg/tsukuru.git
          haxelib install hxnodejs

      - name: Build buildsystem scripts
        run: haxe buildsys.hxml
      
      - name: Build
        if: matrix.config.target != 'windows-amd64'
        run: node build export --target==${{ matrix.config.target }} --build-type=${{ matrix.build_type }} --pkgformat=${{ matrix.config.pkgformat }}
      